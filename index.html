<!doctype html>
<html lang="en">
    <head>
    <!-- Google tag (gtag.js) <script async src="https://www.googletagmanager.com/gtag/js?id=G-DSZCPFBGW9"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-DSZCPFBGW9'); </script>
    --> <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.helpmusicians.org.uk/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.helpmusicians.org.uk/favicon-16x16.png">
    <title>Help Musicians | Income Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" rel="stylesheet" >
    <link href="main.css" rel="stylesheet" >
    <link href="formie-base.css" rel="stylesheet">
    <style>
        .dropdown-menu {
            --bs-dropdown-link-active-bg: #6d30cb;
        }
        .bg-primary{
            background-color: #6d30cb !important;
        }
        #btn-scenario-0, #btn-scenario-1, #btn-scenario-2, #btn-scenario-3, #btn-scenario-4 {
            background-color: #FEF200 !important;
            border-color: #FEF200 !important;
        }
        .no_break{
            display:inline !important;
        }

        .pretend_disabled{
            background-color:rgba(239, 239, 239, 0.3);
border-bottom-color:rgba(118, 118, 118, 0.3);
border-bottom-left-radius:5px;
border-bottom-right-radius:5px;
border-bottom-style:inset;
border-bottom-width:1.6px;
border-image-outset:0;
border-image-repeat:stretch;
border-image-slice:100%;
border-image-source:none;
border-image-width:1;
border-left-color:rgba(118, 118, 118, 0.3);
border-left-style:inset;
border-left-width:1.6px;
border-right-color:rgba(118, 118, 118, 0.3);
border-right-style:inset;
border-right-width:1.6px;
border-top-color:rgba(118, 118, 118, 0.3);
border-top-left-radius:5px;
border-top-right-radius:5px;
border-top-style:inset;
border-top-width:1.6px;
box-sizing:border-box;
color:rgb(84, 84, 84);
cursor:default;
display:block;
float:right;
font-size:12.5px;
font-stretch:100%;
font-weight:400;
height:30.75px;
line-height:14.375px;
margin-bottom:0px;
margin-left:0px;
margin-right:0px;
margin-top:0px;
min-height:30.75px;
overflow-x:visible;
overflow-y:visible;
padding-block-end:5px;
padding-block-start:5px;
padding-bottom:5px;
padding-inline-end:10px;
padding-inline-start:10px;
padding-left:10px;
padding-right:10px;
padding-top:5px;
text-align:right;
text-indent:0px;



        }

    </style>

<!--//'#4F3360','#FEF200','#EFB80B','#8D63E6','#9F7636',-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
</head>
<body>
    <header class="site-header site-header--shape-config-2">
        <div class="container">
            <svg class="shape__circle shape site-header__shape" width="160" height="160" viewBox="0 0 160 160" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="80" cy="80" r="80"></circle></svg>
            <div class="site-header__top">
                <a class="site-logo" href="/"><img src="https://www.helpmusicians.org.uk/assets/logos/_460xAUTO_crop_center-center_none/logo.svg" alt="Help Musicians" width="230" height="79"></a>
                <div class="site-header__top-actions--mobile">
                <!--a class="button--circle button--white" href="/search"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_3794_52683)"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.125 0a8.125 8.125 0 104.793 14.686l5.314 5.343L20 18.262l-5.314-5.344A8.125 8.125 0 008.125 0zM2.5 8.125a5.625 5.625 0 1111.25 0 5.625 5.625 0 01-11.25 0z" fill="currentColor"></path></g></svg><span class="visually-hidden">Search</span></a-->
                <button class="button--circle button--purple" id="mobileNavButton" aria-haspopup="true" aria-controls="mainNav">
                    <svg class="nav-icon--burger" width="18" height="17" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M0 .002h18v2H0zm0 7h18v2H0zm0 7h18v2H0z"></path></svg>
                    <svg class="nav-icon--close" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2512_29533)"><path d="M24 2.418L21.583 0 12 9.583 2.417-.001 0 2.416 9.582 12 0 21.582l2.417 2.417L12 14.417 21.581 24 24 21.583 14.417 12 24 2.418z" fill="currentColor"></path></g><defs><clipPath id="clip0_2512_29533"><path fill="currentColor" d="M0 0h24v24H0z"></path></clipPath></defs></svg>
                    <svg class="nav-icon--active" width="40" height="27" viewBox="0 0 40 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.672 1.992c1.583-2.375 5.073-2.375 6.656 0L40 27H0L16.672 1.992z" fill="currentColor"></path></svg>
                    <span class="visually-hidden">Menu</span>
                </button>
            </div>
        </div>            

        <nav class="site-header__nav" aria-label="Main" id="mainNav">
            <ul role="menu" class="main-nav navbar-nav mr-auto" id="dd">
                <li>&nbsp;</li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_intro" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill intro_menu these_menus"></i><span>Intro</span><i class="bi bi-caret-left-fill intro_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_current" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill current_menu these_menus"></i><span>Current<!-- Income--></span><i class="bi bi-caret-left-fill current_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_summary" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill summary_menu these_menus"></i><span>Summary</span><i class="bi bi-caret-left-fill summary_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_target" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill target_menu these_menus"></i><span>Target</span><i class="bi bi-caret-left-fill target_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_tinker" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill tinker_menu these_menus"></i><span>Plan</span><i class="bi bi-caret-left-fill tinker_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_compare" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill compare_menu these_menus"></i><span>Compare</span><i class="bi bi-caret-left-fill compare_menu these_menus"></i></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_excel" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><span>Export to Excel</span></a>
                </li>
                <li role="none" class="main-nav__top-level-li">
                    <a id="a_next" role="menuitem" tabindex="0" class="main-nav__top-level-a menus" href="#"><i class="bi bi-caret-right-fill next_menu these_menus"></i><span>Next Steps</span><i class="bi bi-caret-left-fill next_menu these_menus"></i></a>
                </li>
             </ul>
         </nav>   
  </header>


  <form id="frm" method="post" class="form-floating">
  <div id="page_content" class="container-fluid">

    <div id="intro_content" class="container div_content">
        <div class="row">
            <div class="col-12">
                <h4>Introductory Heading</h4>
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                <h4>Introductory Heading</h4>
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
                Introductory content goes here Introductory content goes here 
            </div>
           
        </div>
    </div>

    <div id="next_content" class="container div_content">
        <div class="row">
            <div class="col-12">
                <h4>Next Steps Heading</h4>
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                <h4>Next Steps Heading</h4>
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here
                Next steps content goes here Next steps content goes here 
                Next steps content goes here Next steps content goes here 
            </div>
        </div>
    </div>
    
    <div id="target_content" class="container div_content">
        <div class="row">
            <div class="col-12"><h4>Target</h4></div>
        </div>
        <div class="row">
            <div class="col-6">How much you want to earn in the next 12 months?</div>
            <div class="col-2" id="target_input_div"></div>
            <div class="col-2" id="target_button_div">
                <button type="button" id="btn_target" class="btn btn-primary"">Set Target</button>
            </div>
        </div>
    </div> 

    <div id="summary_content" class="container div_content">
        <div class="row">
            <div class="col-12"><canvas id="chart0" width="1200" height="300"></canvas></div>
        </div>
    </div> 

    <div id="compare_content" class="container div_content">
        <div class="row the_four">
            <div class="col-6"><h4>Current</h4></div>
            <div class="col-6"><h4>Comparisons</h4></div>
        </div>
        <div class="row the_four">
            <div class="col-6"></div>
            <div class="col-2"><button type="button" id="btn_compare_recording" class="btn btn_compare btn-primary btn-lg"">Mainly Recording</button></div>
            <div class="col-2"><button type="button" id="btn_compare_live" class="btn btn_compare btn-outline-primary btn-lg">Mainly Live</button></div>
            <div class="col-2"><button type="button" id="btn_compare_publishing" class="btn btn_compare btn-outline-primary btn-lg"">Mainly Publishing</button></div>
        </div>
        <div class="row the_four">
            <div class="col-6"><canvas id="chart2" width="400" height="400"></canvas></div>
            <div class="col-6"><canvas id="chart3" width="400" height="400"></canvas></div>
        </div>
    </div> 

    <div id="current_content" class="container div_content">
         <!-- dynamic content hopefully gets loaded here -->
    </div>

    <div id="chart_content" class="container div_content">
        <div id="tinker_chart" class="row ">
            <div class="col-12"><canvas id="chart1" width="800" height="800"></canvas></div>
        </div>
    </div>

   
   

    <!--export to excel table  -->
<table id="exportable" summary="Table Summary" rules="groups" frame="hsides" border="2" class="d-none" >
    <caption>Help Musicians Earnings Model Data Export</caption>
    <thead valign="top">
    <tr>
        <th rowspan="2" valign="top">Category</th>
        <th rowspan="2" valign="top">Entry</th>
        <th colspan="3">Current</th>
        <th colspan="3">Proposed</th>        
    </tr>
    <tr>
        <th>£/unit</th>
        <th>Units</th>
        <th>Total</th>
        <th>£/unit</th>
        <th>Units</th>
        <th>Total</th>
    </tr>
    </thead>
    <tbody id="exportable_data">
    <tr>
        
    </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="6" id="return_link"></td>
        </tr>
    </tfoot>
</table>
<!--export to excel table -->
    


  </div>
  </form>

  <script>
    var input_standard_classes = "w-100 float-end text-end blur form-control-lg"//w-75
    var input_text_classes = "w-75 blur form-control-lg"
    var page = "Intro"
    var scenario = -1
    var delim='|'
    var sep='~'
    var bURLs=false
    var ctx0 = document.getElementById("chart0").getContext("2d");//summary
    var ctx1 = document.getElementById("chart1").getContext("2d");//plan
    var ctx2 = document.getElementById("chart2").getContext("2d");//compare (summary)
    var ctx3 = document.getElementById("chart3").getContext("2d");//compare (scenario)

    var target=0;
    var selected_proportion=0;
    var colors = [  
                '#4F3360','#FEF200','#EFB80B','#8D63E6','#9F7636',
                '#3600FF','#B0BEB4','#596387','#21517F','#4D0E78',
                '#5163FD','#650882','#0BBEB4','#96387F','#F1517',
                '#DD0E78','#FF63FD','#000882','#F600FF','#0044B4',
                '#0FF360','#66BEB4','#596387','#36F17F','#4D0E78',
            ]
    
    //48 values
    var scenarios = [
        {specialism: "Developing", characteristics: "Small number of recorded materials and streams, no publishing, live gigs only" ,
            values: [
                [{val:-1,per:-1},{val:0,per:7},{val:100,per:6},{val:10000,per:0.00350806994},{val:5000,per:0.00055390578},{val:1,per:100},{val:0,per:50}],
                [{val:-1,per:-1},{val:-1,per:3},{val:100,per:2},{val:10000,per:(0.00350806994*0.12)},{val:5000,per:(0.00055390578*0.12)},{val:1,per:100},{val:-1,per:50},{val:-1,per:50}],
                [{val:-1,per:-1},{val:10,per:75},{val:2,per:100},{val:2,per:50},{val:2,per:150},{val:10,per:100}],
                [{val:-1,per:10},{val:-1,per:75},{val:0,per:100},{val:0,per:50}],
                [{val:-1,per:0},{val:-1,per:0},{val:0,per:0},{val:0,per:0}]            
            ]
        },
        {specialism: "Emerging", characteristics: "Recorded and released album, more streams (30,000+), very small publishing, live gigs" ,
            values: [
            [{val:-1,per:5000},{val:100,per:7},{val:300,per:6},{val:1000000,per:0.00350806994},{val:500000,per:0.00055390578},{val:5,per:100},{val:20,per:50}],
                [{val:-1,per:-1},{val:100,per:3},{val:300,per:2},{val:1000000,per:(0.00350806994*0.12)},{val:500000,per:(0.00055390578*0.12)},{val:10,per:100},{val:-1,per:50},{val:50,per:50}],
                [{val:-1,per:-1},{val:10,per:100},{val:2,per:100},{val:2,per:50},{val:2,per:150},{val:10,per:100}],
                [{val:-1,per:10},{val:0,per:200},{val:0,per:200},{val:0,per:100}],
                [{val:-1,per:0},{val:-1,per:0},{val:0,per:0},{val:0,per:0}]     
            ]
        },
        {specialism: "Experienced– mainly recorded", characteristics: "One largely successful release or multiple consistent sellers • Sales, radio and/or sync licensing • Touring venues (500-3k capacity) • Next release is anticipated by fans, press and industry" ,
            values: [
                [{val:1,per:7500},{val:300,per:7},{val:500,per:6},{val:1200000,per:0.00350806994},{val:1500000,per:0.00055390578},{val:5,per:200},{val:35,per:50}],
                [{val:-1,per:3000},{val:300,per:3},{val:500,per:2},{val:1200000,per:(0.00350806994*0.12)},{val:1500000,per:(0.00055390578*0.12)},{val:10,per:200},{val:-1,per:50},{val:50,per:50}],
                [{val:-1,per:-1},{val:12,per:200},{val:6,per:200},{val:2,per:50},{val:3,per:250},{val:5,per:100}],
                [{val:-1,per:10},{val:-1,per:500},{val:1,per:500},{val:1,per:100}],
                [{val:-1,per:0},{val:-1,per:0},{val:0,per:0},{val:0,per:0}]     
            ]
        },
        {specialism: "Experienced – mainly live", characteristics: "One largely successful release or multiple consistent sellers • Sales, radio and/or sync licensing • Touring venues (500-3k capacity) • Next release is anticipated by fans, press and industry" ,
            values: [
            [{val:-1,per:5000},{val:200,per:7},{val:350,per:6},{val:1200000,per:0.00350806994},{val:1500000,per:0.00055390578},{val:0,per:200},{val:0,per:50}],
                [{val:-1,per:1500},{val:400,per:3},{val:800,per:2},{val:1000000,per:(0.00350806994*0.12)},{val:2000000,per:(0.00055390578*0.12)},{val:10,per:200},{val:-1,per:50},{val:50,per:50}],
                [{val:2,per:500},{val:9,per:350},{val:12,per:400},{val:3,per:150},{val:6,per:750},{val:5,per:100}],
                [{val:150,per:10},{val:1,per:500},{val:1,per:500},{val:2,per:100}],
                [{val:-1,per:0},{val:-1,per:0},{val:0,per:0},{val:0,per:0}]     
            ]
        },
        {specialism: "Experienced – writer/producer", characteristics: "One largely successful release or multiple consistent sellers • Sales, radio and/or sync licensing • Touring venues (500-3k capacity) • Next release is anticipated by fans, press and industry" ,
            values: [
            [{val:-1,per:-1},{val:0,per:7},{val:0,per:6},{val:0,per:0.00350806994},{val:0,per:0.00055390578},{val:0,per:1},{val:0,per:50}],
                [{val:1,per:10000},{val:500,per:3},{val:1000,per:2},{val:2000000,per:(0.00350806994*0.12)},{val:2000000,per:(0.00055390578*0.12)},{val:25,per:200},{val:50,per:200},{val:50,per:50}],
                [{val:-1,per:500},{val:-1,per:400},{val:-1,per:400},{val:-1,per:150},{val:-1,per:750},{val:-1,per:100}],
                [{val:-1,per:10},{val:-1,per:200},{val:0,per:200},{val:0,per:100}],
                [{val:-1,per:0},{val:-1,per:0},{val:0,per:0},{val:0,per:0}]     
            ]
        },
        
    
    ]
  
    //currently 15, 15, 4, 4, 5, 5 = 48
    var data = [
    {heading:"Recorded Music", current_total: 0, proposed_total: 0,
        entries:[
            {title:"Rec - Advance",  color: colors[0], help: "An advance is a lump sum paid in advance of expected royalties, and is repaid from future royalty earnings. The Recorded Music Advance refers to any lump sum advance paid for your existing or future recordings (but not the underlying songs, which would be paid under publishing)"},
            {title:"Rec -  Vinyl Sales",  color: colors[0], help: "Sound recording (Master) revenue from sales of Vinyl"},
            {title:"Rec - Music  Sales (CD and Download)",  color: colors[0], help: "Sound recording (Master) revenue from downloads and sales of physical products, excluding Vinyl"},
            {title:"Rec - Audio Streams",  color: colors[0], help: "Sound recording (Master) revenue from Digital Service Providers (DSPs) like Spotify, Apple Music, Soundcloud and Deezer"},
            {title:"Rec - Video Streams",  color: colors[0], help: "Sound recording (Master) revenue from Video Service Providers like YouTube"},
            {title:"Rec - Sync",  color: colors[0], help: "Sound recording (Master) revenue from having your music used in film, TV, games, adverts and other contexts where a sync fee is paid."},
            {title:"PPL Royalties",  color: colors[0], help: "Sound recording (Master and Neighbouring rights) royalties paid for the use of your music in the UK and overseas. If someone other than PPL collects these on your behalf you can still include the revenue here."},
            {title:"Other Recorded Music",  color: colors[0], help: "Other sound recording income not captured above"},
        ]
    },
    {heading:"Music Publishing", current_total: 0, proposed_total: 0,
        entries: [
            {title:"Pub - Advance",  color: colors[0], help: "An advance is a lump sum paid in advance of expected royalties, and is repaid from future royalty earnings. The Publisher Advance refers to any lump sum advance paid for your existing or future songs (but not the recordings of those songs)"},
            {title:"Pub -  Vinyl Sales",  color: colors[0], help: "Publishing income from pressing of Vinyl (Mechanical Rights)"},
            {title:"Pub - Music  Sales (CD and Download)",  color: colors[0], help: "Publishing income (Mechanical and Performing) from downloads and sales of physical products, excluding Vinyl"},
            {title:"Pub - Audio Streams",  color: colors[0], help: "Publishing income (Mechanical and Performing) from Digital Service Providers (DSPs) like Spotify, Apple Music, Soundcloud and Deezer"},
            {title:"Pub - Video Streams",  color: colors[0], help: "Publishing income (Mechanical and Performing) from Video Service Providers like YouTube"},
            {title:"Pub - Sync",  color: colors[0], help: "Publishing income paid for having your music used in film, TV, games, adverts and other contexts where a sync fee is paid."},
            {title:"Commissions",  color: colors[0], help: "Fees paid to create music for a specific purpose, not covered above, such as writing for a computer game."},
            {title:"PRS Royalties",  color: colors[0], help: "Publishing royalties paid for the use of your music in the UK and overseas, other than for those listed above. This includes your music being played on the radio, in the background in bars and much more. If someone other than PRS for Music collects these on your behalf you can still include the revenue here."},
            {title:"Other Music Publishing",  color: colors[0], help: "Other music publishing income not captured above."},
        ]
    },
    {heading:"Live Music", current_total: 0, proposed_total: 0,
        entries: [
            {title:"International Tour",  color: colors[0], help: "Revenue from international touring."},
            {title:"Domestic Tour",  color: colors[0], help: "Revenue from domestic touring."},
            {title:"One off concerts",  color: colors[0], help: "Revenue paid from one off shows, that do not form part of a tour."},
            {title:"Support slot",  color: colors[0], help: "Revenue paid from support slots."},
            {title:"Private shows",  color: colors[0], help: "Revenue paid from private events."},
            {title:"Session ",  color: colors[0], help: "Revenue paid from playing live as a session musician for other artists."},
            {title:"Other Live Music ",  color: colors[0], help: "Other live music income not captured above."},
        ]
    },
    {heading:"Brand and Image", current_total: 0, proposed_total: 0,
        entries: [
            {title:"Merchandise",  color: colors[0], help: "Revenue from selling merchandise (if you sell CDs at shows as merch be careful not to double count the income captured above)."},
            {title:"Brand Partnerships",  color: colors[0], help: "Revenue from partnerships with brands to promote their products."},
            {title:"Sponsorships",  color: colors[0], help: "Revenue from sponsorships (excluding brand partnerships above)."},
            {title:"Influencer income",  color: colors[0], help: "Revenue from infulencer activities not captured above."},
            {title:"Other Brand and Image",  color: colors[0], help: "Other brand and image income not captured above."},
        ]
    },
    {heading:"Other Income", current_total: 0, proposed_total: 0,
        entries: [
            {title:"Crowdfunding",  color: colors[0], help: "Income from crowdfunding campaigns."},
            {title:"Grants",  color: colors[0], help: "Income from grants you have received."},
            {title:"Gifts",  color: colors[0], help: "Income from gifts."},
            {title:"Investment",  color: colors[0], help: "Direct investment from private individuals, fans or professional investors excluding advances captured above."},
            {title:"Subscription (such as Patreon)",  color: colors[0], help: ""},
            {title:"Teaching",  color: colors[0], help: "Income from teaching."},
            {title:"Conducting",  color: colors[0], help: "Income from conducting work."},
            {title:"Arranging ",  color: colors[0], help: "Income from arrangement work."},
            {title:"Instrument making/repairs",  color: colors[0], help: "Income from work creating or repairing instruments."},
            {title:"Additional Income One",  color: colors[0], help: "Please add anything you would like to capture that is not included above."},
            {title:"Additional Income Two",  color: colors[0], help: "Please add anything else you would like to capture.  If you have more than 2 other income streams please combine them and the use the total here."},
        ]
    }
]

$( document ).ready(function() {

    //hide all the menu indicators
    $(".these_menus").addClass("d-none")

    //hide all the content
    $(".div_content").addClass("d-none")

    //turn on the intro menu and content
    $(".intro_menu").removeClass("d-none");$("#intro_content").removeClass("d-none")

    //create the current form
    fn_construct_current()

    //check for url parameters
    pop()

   

    /*---------------------------------------------------------------------------------------------------
    ------------------------------------------    functions    ------------------------------------------
    -----------------------------------------------------------------------------------------------------*/
    function pop(){
                
        if(scenario!=-1){
            //which scenario has been selected?
            this_scenario = scenarios[scenario]

            //important that the scenario values follows the same data pattern as the data [15],[15],[4],[4],[5],[5] currently
            for(i in this_scenario.values){
                for(j in this_scenario.values[i]){
                    this_couplet=this_scenario.values[i][j]

                    per1=$("#per1_"+String(i)+"_"+String(j))
                    per2=$("#per2_"+String(i)+"_"+String(j))
                    tot1=$("#tot1_"+String(i)+"_"+String(j))
                    tot2=$("#tot2_"+String(i)+"_"+String(j))
                    val1=$("#val1_"+String(i)+"_"+String(j))
                    val2=$("#val2_"+String(i)+"_"+String(j))
                    if(this_couplet.val!=-1){
                        per1.val(this_couplet.per)
                        val1.val(this_couplet.val)
                        tot1.val(this_couplet.per * this_couplet.val)
                    }else{
                        per1.val("")
                        val1.val("")
                        tot1.val("")
                    }

                    if(this_couplet.val!=-1){
                        per2.val(this_couplet.per)
                        val2.val(this_couplet.val)
                        tot2.val(this_couplet.per * this_couplet.val)
                    }else{
                        per2.val("")
                        val2.val("")
                        tot2.val("")
                    }
                }
            }
        }

        //lets override scenario based defaults with anything passed in the url


        //lets populate the values!
        searchParams = new URLSearchParams(window.location.search);

        couplets=[];
        counter=0;
        if(searchParams.has('v')){
            bURLs=true
            couplets = searchParams.get('v').split(sep)
            for(i in data){
                for(j in data[i].entries){

                    if(couplets.length > counter+1){
                        per1=$("#per1_"+String(i)+"_"+String(j))
                        per2=$("#per2_"+String(i)+"_"+String(j))
                        val1=$("#val1_"+String(i)+"_"+String(j))
                        val2=$("#val2_"+String(i)+"_"+String(j))
                        tot1=$("#tot1_"+String(i)+"_"+String(j))
                        tot2=$("#tot2_"+String(i)+"_"+String(j))

                        values=couplets[counter].split(delim)

                       if(values[0]==""){                 per1.val=""}else{per1.val(parseInt(values[0],16))}
                       if(values.length<2||values[1]==""){val1.val=""}else{val1.val(parseInt(values[1],16))}
                       if(values.length<3||values[2]==""){tot1.val=""}else{tot1.val(parseInt(values[2],16))}
                       if(values.length<4||values[3]==""){per2.val=""}else{per2.val(parseInt(values[3],16))}
                       if(values.length<5||values[4]==""){val2.val=""}else{val2.val(parseInt(values[4],16))}
                       if(values.length<6||values[5]==""){tot2.val=""}else{tot2.val(parseInt(values[5],16))}
                      
                        counter= counter+1
                    }
                }
            }
        }

        if(searchParams.has('s')){
            scenario =  searchParams.get('s')
            bURLs=true
        }

        if(searchParams.has('t')){
            target =  parseInt(searchParams.get('t'),16)
            bURLs=true
        }

        var clean_uri = location.protocol + "//" + location.host + location.pathname;
        window.history.replaceState({}, document.title, clean_uri);

        fn_scenario_update()//this will also take care of the totals

        if(bURLs){
            //shall we go current or tinker?
            $("#current_content").removeClass("d-none")
            $(".proposed").removeClass("d-none")
            console.log("bURLS!")
        }
        


    }

    function fn_construct_current(){
        //console.log("go through the dataset and construct the form")
        anchor=$("#current_content")

        tar_div=$("#target_input_div")
        tar_inp = $("<input>").addClass(input_standard_classes).attr("id","target")
        tar_div.append(tar_inp)

        //-----------------------------------------------------------------------headings
        div_row=$("<div>")
            .attr("id","row_heading")
            .addClass("row")
            .addClass("mt-4")
            
        div_content=$("<div>")
            .attr("id","row_blank_heading")
            .addClass("col-6")

        div_row.append(div_content)//add the first five cols to the row

        div_content=$("<div>")
            .attr("id","row_c_heading")
            .addClass("col-1")
        h4_text=$("<h4>")
        h4_text.append("Current")
        div_content.append(h4_text)
        div_row.append(div_content)//add the Current to the row

        div_empty1= $("<div>").addClass("col-1")
        div_tot1=$("<div>").addClass("col-1")
        tot1 =$("<input />")
            .attr("id","tot1_heading")
            .attr("name","tot1_heading")
            .addClass(input_standard_classes)
            .attr("disabled",true)
        div_tot1.append(tot1)
        div_row.append(div_empty1).append(div_tot1)

        div_content=$("<div>")
            .attr("id","row_c_heading")
            .addClass("col-1")
            .addClass("proposed")
        h4_text=$("<h4>")
        h4_text.append("Plan")
        div_content.append(h4_text)
        div_row.append(div_content)//add the Plan to the row

        div_empty2= $("<div>").addClass("col-1").addClass("proposed")
        div_tot2=$("<div>").addClass("col-1").addClass("proposed")
        tot2 =$("<input />")
            .attr("id","tot2_heading")
            .attr("name","tot2_heading")
            .addClass(input_standard_classes)
            .attr("disabled",true)
        div_tot2.append(tot2)
        
        div_row.append(div_empty2).append(div_tot2)
    
        anchor.append(div_row)


        //now we add a largely empty row with the Gap field in it
        div_row=$("<div>")
            .attr("id","row_heading")
            .addClass("row")
            .addClass("mt-4")
            
        div_content=$("<div>")
            .attr("id","row_blank_heading")
            .addClass("col-9")

        div_row.append(div_content)//add the first nine blank cols to the row

        div_content=$("<div>")
            .attr("id","row_c_heading")
            .addClass("col-1")
            .addClass("proposed")
        h4_text=$("<h4>")
            .append("Gap")
            .addClass("no_break")
        div_content.append(h4_text)

        info= $("<i>").addClass("bi bi-info-square mx-2")
            .attr("data-toggle","tooltip")
            .attr("data-placement","top")
            .attr("data-html","true")
            .attr("data-original-title","A negative number in the gap field indicates that the target has been achieved and surpassed")
        div_content.append(info)

        div_row.append(div_content)//add the Gap heading to the row

        div_empty3= $("<div>").addClass("col-1").addClass("proposed")
        div_tot3=$("<div>").addClass("col-1").addClass("proposed")
        tot3 =$("<input />")
            .attr("id","gap")
            .attr("name","gap")
            .addClass(input_standard_classes)
            .attr("disabled",true)
        div_tot3.append(tot3)
        
        div_row.append(div_empty3).append(div_tot3)
    
        anchor.append(div_row)
//-----------------------------------------------------------------------/headings


         //run through the data and set up the fields (no values)
         for(datum in data){

            //we have a toggle within a span, attached to a h4 along with the actual heading text which is atte
            div_row=$("<div>")
                .attr("id","row_" + String(datum))
                .addClass("row")
                .addClass("mt-4")
            
            div_content=$("<div>")
                .attr("id","row_c_" + String(datum))
                .addClass("col-6")
                
            h4_text=$("<h4>")
            span = $("<span>")
                
            toggle_text = $("<i>")
                .addClass("bi toggle_section")
                .attr("id","toggle_"+String(datum))
                .html("&nbsp;")
                .addClass("bi-plus-square")

            span.append(toggle_text)
            h4_text.append(span)
            h4_text.append(data[datum].heading)
            div_content.append(h4_text)

            div_lbsperunit1= $("<div>")
                .attr("id","section_heading_lbsper1_"+String(datum))
                .addClass("col-1").addClass("section_headings").addClass("section_heading_"+String(datum))
                .html("£/Unit")
            div_unit1= $("<div>")
                .attr("id","section_heading_units1_"+String(datum))
                .addClass("col-1").addClass("section_headings").addClass("section_heading_"+String(datum))
                .html("Units")
            div_lbsperunit2= $("<div>")
                .attr("id","section_heading_lbsper2_"+String(datum))
                .addClass("col-1").addClass("section_headings").addClass("section_heading_"+String(datum)).addClass("proposed")
                .html("£/Unit")
            div_unit2= $("<div>")
                .attr("id","section_heading_units2_"+String(datum))
                .addClass("col-1").addClass("section_headings").addClass("section_heading_"+String(datum)).addClass("proposed")
                .html("Units")

            div_tot1=$("<div>").addClass("col-1")
            div_tot2=$("<div>").addClass("col-1").addClass("proposed")

            tot1 =$("<input />")
                .attr("id","tot1_" + String(datum))
                .attr("name","tot1_" + String(datum))
                .addClass(input_standard_classes)
                .attr("disabled",true)

            tot2 =$("<input />")
                .attr("id","tot2_" + String(datum))
                .attr("name","tot2_" + String(datum))
                .addClass(input_standard_classes)
               .attr("disabled",true)

            div_tot1.append(tot1)
            div_tot2.append(tot2)
            
            div_row
                .append(div_content)
                .append(div_lbsperunit1)
                .append(div_unit1)
                .append(div_tot1)
                .append(div_lbsperunit2)
                .append(div_unit2)
                .append(div_tot2)
        
            anchor.append(div_row)
        
            for(entry in data[datum].entries){

                div_row=$("<div>")
                    .attr("id","row_" + String(datum)+"_"+String(entry))
                    .addClass("row")
                    .addClass("row_"+String(datum))
                    .addClass("entry_row")
                    .addClass("d-none")
                
                all_cols =  "col-1"   
                div_entry = $("<div>").addClass("col-6").addClass("text-nowrap")
                div_per1 = $("<div>").addClass(all_cols).addClass("tot_unit")                       .attr("id","div_per1_" + String(datum)+"_"+String(entry))
                div_per2 = $("<div>").addClass(all_cols).addClass("tot_unit").addClass("proposed")  .attr("id","div_per2_" + String(datum)+"_"+String(entry))
                div_tot1 = $("<div>").addClass(all_cols).addClass("tot_unit")                       .attr("id","div_tot1_" + String(datum)+"_"+String(entry))
                div_tot2 = $("<div>").addClass(all_cols).addClass("tot_unit").addClass("proposed")  .attr("id","div_tot2_" + String(datum)+"_"+String(entry))
                div_val1 = $("<div>").addClass(all_cols).addClass("tot_unit").addClass("mr-4")      .attr("id","div_val1_" + String(datum)+"_"+String(entry))
                div_val2 = $("<div>").addClass(all_cols).addClass("tot_unit").addClass("proposed")  .attr("id","div_val2_" + String(datum)+"_"+String(entry))

                title=$("<span>")
                    .html(data[datum].entries[entry].title)
                div_entry.append(title)

                info= $("<i>").addClass("bi bi-info-square mx-2")
                    .attr("data-toggle","tooltip")
                    .attr("data-placement","top")
                    .attr("data-html","true")
                    .attr("data-original-title",data[datum].entries[entry].help)
                div_entry.append(info)

                per1 =$("<input />")
                    .attr("id","per1_" + String(datum)+"_"+String(entry))
                    .attr("name","per1_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("current")
                    .change(function(){fn_scenario_update()  })
                div_per1.append(per1)

                val1 =$("<input />")
                    .attr("id","val1_" + String(datum)+"_"+String(entry))
                    .attr("name","val1_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("current")
                    .change(function(){fn_scenario_update()  })
                div_val1.append(val1)

                tot1 =$("<input />")
                    .attr("id","tot1_" + String(datum)+"_"+String(entry))
                    .attr("name","tot1_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("pretend_disabled")
                    .change(function(){fn_scenario_update()  })
                    //.attr("disabled","disabled")
                div_tot1.append(tot1)

                per2 =$("<input />")
                    .attr("id","per2_" + String(datum)+"_"+String(entry))
                    .attr("name","per2_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("prop")
                    .change(function(){fn_scenario_update()  })
                div_per2.append(per2)

                val2 =$("<input />")
                    .attr("id","val2_" + String(datum)+"_"+String(entry))
                    .attr("name","val2_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("prop")
                    .change(function(){fn_scenario_update()  })
                div_val2.append(val2)

                tot2 =$("<input />")
                    .attr("id","tot2_" + String(datum)+"_"+String(entry))
                    .attr("name","tot2_" + String(datum)+"_"+String(entry))
                    .addClass(input_standard_classes)
                    .addClass("pretend_disabled")
                    //.attr("disabled","disabled")
                    .change(function(){fn_scenario_update()  })
                div_tot2.append(tot2)

                div_row.append(div_entry).append(div_per1).append(div_val1).append(div_tot1).append(div_per2).append(div_val2).append(div_tot2)
                anchor.append(div_row)
            }

            //lastly turn off each sections headings of Units and £/Unit
            $(".section_headings").html("&nbsp;")
            
        }
    }

    function fn_scenario_update(){
        console.log("updating scenarios",scenario)
        grand_current_total=0
        grand_proposed_total=0

        for(datum in data){
            current_total=0
            proposed_total=0

            for(entry in data[datum].entries){
                per1=$("#per1_"+String(datum)+"_"+String(entry))
                per2=$("#per2_"+String(datum)+"_"+String(entry))
                val1=$("#val1_"+String(datum)+"_"+String(entry))
                val2=$("#val2_"+String(datum)+"_"+String(entry))
                tot1=$("#tot1_"+String(datum)+"_"+String(entry))                
                tot2=$("#tot2_"+String(datum)+"_"+String(entry))

                if(tot1.val()!=""){current_total = current_total + parseInt(tot1.val())}
                if(tot2.val()!=""){proposed_total = proposed_total + parseInt(tot2.val())}
               
            }
            data[datum].current_total=parseInt(current_total)
            data[datum].proposed_total=parseInt(proposed_total)
            grand_current_total=parseInt(grand_current_total)+parseInt(current_total)
            grand_proposed_total=parseInt(grand_proposed_total)+parseInt(proposed_total)

            //console.log(data[datum].heading,current_total,proposed_total,$("#tot1_"+String(datum)))
            $("#tot1_"+String(datum)).val(current_total.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0}))              
            $("#tot2_"+String(datum)).val(proposed_total.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0}))
        }
        chart()
        
        gap_amt = grand_current_total-grand_proposed_total;
        //console.log(grand_current_total,target,grand_proposed_total,gap_amt)    
        $("#tot1_heading").val(grand_current_total.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0}))
        $("#tot2_heading").val(grand_proposed_total.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0}))
        $("#gap").val(gap_amt.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0}))
    
    
    }

    /*------- charts -------*/
    function fn_floor(input){
        if(input < 0){return 0}else{return input}
    }

    function fn_destroy_charts(){ 
        if(typeof c0 != 'undefined'){c0.destroy()}//summary
        if(typeof c1 != 'undefined'){c1.destroy()}//plan
        if(typeof c2 != 'undefined'){c2.destroy()}//compare (summary)
        if(typeof c3 != 'undefined'){c3.destroy()}//compare (scenario)
    }
    
    function chart(){

        labels1=["Current"];labels3=[""];labels6=["Current","Plan"];
        datasets1=[];datasets2=[];datasets3=[];datasets6=[];data_for_dataset2=[] 
        current_total=0
        proposed_total=0

        //console.log(selected_proportion)
        /*-----prep for charts ----*/
        for(datum in data){
            current_total=current_total+data[datum].current_total;
            proposed_total=proposed_total+data[datum].proposed_total;
            datasets1.push(
                {label: data[datum].heading, 
                data: [
                    data[datum].current_total
                ],  borderColor: colors[datum], backgroundColor: colors[datum]})

            datasets6.push(
                {label: data[datum].heading, 
                data: [
                    data[datum].current_total
                    , data[datum].proposed_total
                ],  borderColor: colors[datum], backgroundColor: colors[datum]})
        }
        
        proportions=[
            {title:"Mainly Recording",  proportions:[0.45,0.15,0.10,0.10,0.20]},
            {title:"Mainly Live",       proportions:[0.15,0.15,0.35,0.15,0.20]},
            {title:"Mainly Publishing", proportions:[0.15,0.45,0.10,0.10,0.20]},
        ]
        
        for(datum in data){
            datasets3.push(
                {label:proportions[selected_proportion].title+ ": "+data[datum].heading, 
                data: [
                    current_total* proportions[selected_proportion].proportions[datum]
                ],  borderColor: colors[datum], backgroundColor: colors[datum]})      
        }

        datasets2 = [
            {label: "Current", data:data_for_dataset2,backgroundColor: 'rgba(109, 48, 203, 0.0)',borderColor: 'rgb(109, 48, 203)',borderWidth: 1,},
        ]


       // '#4F3360','#FEF200','#EFB80B','#8D63E6','#9F7636'

        //wipe out all the charts to recreate them
        fn_destroy_charts()

        //chart by chart
        c0= new Chart(ctx0,{type: 'bar', 
                data:{
                    labels: labels1, 
                    datasets: datasets1, 
                   // pointBackgroundColor
                },
                plugins: [ChartDataLabels],
                options:{
                    locale: "en-UK",
                    scales: {
                        x:{stacked:true},
                        y:{stacked:true, 
                            ticks:{ callback: (value, index, values) => {return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});},font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        }
                    },
                    plugins: {
                        legend:{ display:true, position:'right',labels:{font:{size:14, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                        title:{display: false,font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        tooltip:{
                            callbacks:{
                                title: function(context){
                                    return false
                                },
                                label: function(context){
                                    let title = context.label;
                                    let data = context.dataset.label
                                    let value = context.raw.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0})
                                    return title + " " + data + " " + String(value) 
                                }
                            }
                        },
                        datalabels: {display: false,
                            formatter: function(value, context) {
                                return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});
                            },
                            labels: {title: {color: 'black',font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                            anchor: "end", align: "end"
                        } 
                    }  
                }
            }    
        )

        c1= new Chart(ctx1,{type: 'bar', 
                data:{
                    labels: labels6, 
                    datasets: datasets6, 
                   // pointBackgroundColor
                },
                plugins: [ChartDataLabels],
                options:{
                    locale: "en-UK",
                    scales: {
                        x:{stacked:true},
                        y:{stacked:true, 
                            ticks:{ callback: (value, index, values) => {return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});},font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        }
                    },
                    plugins: {
                        legend:{ display:true, position:'right',labels:{font:{size:14, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                        title:{display: false,font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        tooltip:{
                            callbacks:{
                                title: function(context){
                                    return false
                                },
                                label: function(context){
                                    let title = context.label;
                                    let data = context.dataset.label
                                    let value = context.raw.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0})
                                    return title + " " + data + " " + String(value) 
                                }
                            }
                        },
                        datalabels: {display: false,
                            formatter: function(value, context) {
                                return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});
                            },
                            labels: {title: {color: 'black',font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                            anchor: "end", align: "end"
                        } 
                    }  
                }
            }    
        )

         //chart by chart
         c2= new Chart(ctx2,{type: 'bar', 
                data:{
                    labels: labels1, 
                    datasets: datasets1, 
                   // pointBackgroundColor
                },
                plugins: [ChartDataLabels],
                options:{
                    locale: "en-UK",
                    scales: {
                        x:{stacked:true},
                        y:{stacked:true, 
                            ticks:{ callback: (value, index, values) => {return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});},font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        }
                    },
                    plugins: {
                        legend:{ display:false, position:'right',labels:{font:{size:14, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                        title:{display: false,font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        tooltip:{
                            callbacks:{
                                title: function(context){
                                    return false
                                },
                                label: function(context){
                                    let title = context.label;
                                    let data = context.dataset.label
                                    let value = context.raw.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0})
                                    return title + " " + data + " " + String(value) 
                                }
                            }
                        },
                        datalabels: {display: false,
                            formatter: function(value, context) {
                                return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});
                            },
                            labels: {title: {color: 'black',font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                            anchor: "end", align: "end"
                        } 
                    }  
                }
            }    
        )

       //chart by chart
       c3= new Chart(ctx3,{type: 'bar', 
                data:{
                    labels: labels3, 
                    datasets: datasets3, 
                   // pointBackgroundColor
                },
                plugins: [ChartDataLabels],
                options:{
                    locale: "en-UK",
                    scales: {
                        x:{stacked:true},
                        y:{stacked:true, 
                            ticks:{ callback: (value, index, values) => {return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});},font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        }
                    },
                    plugins: {
                        legend:{ display:false, position:'right',labels:{font:{size:14, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                        title:{display: false,font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},},
                        tooltip:{
                            callbacks:{
                                title: function(context){
                                    return false
                                },
                                label: function(context){
                                    let title = context.label;
                                    let data = context.dataset.label
                                    let value = context.raw.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0})
                                    return title + " " + data + " " + String(value) 
                                }
                            }
                        },
                        datalabels: {display: false,
                            formatter: function(value, context) {
                                return value.toLocaleString('en-UK',{style:"currency", currency: "GBP",minimumFractionDigits: 0, maximumFractionDigits: 0});
                            },
                            labels: {title: {color: 'black',font:{size:16, family: 'system-ui,-apple-system,"Segoe UI",Roboto'},}},
                            anchor: "end", align: "end"
                        } 
                    }  
                }
            }    
        )





    }
/*circle''cross''crossRot''dash''line''rect''rectRounded''rectRot''star''triangle' false*/
    /*------- excel -------*/
    function fn_export_excel(){
        var exp = $("#exportable_data")
        var rl = $("#return_link")
        var ci = $("#chart_img")
        //wipe existing data
        exp.html("")
        var heading;
        var row;
        var cell;
        var local;
        var v='';
        var excel_row;
        
        /*
        <th>Category</th>               
        <th>Entry</th>                  
        <th>£/unit</th>       
        <th>Unts</th>  
        <th>£/unit</th>       
        <th>Unts</th>       
        */
        excel_row=3;
        //populate the hidden table with all the data
        for(s in data){
            heading=data[s].heading
            for(e in data[s].entries){
                local=data[s].entries[e]
                revperitem=''
                val=''

                row=$("<tr />")
                cell=$("<td />").html(heading); row.append(cell)
                cell=$("<td />").html(local.title); row.append(cell)
                
                per1=$("#per1_"+String(s)+"_"+String(e)).val()
                per2=$("#per2_"+String(s)+"_"+String(e)).val()
                val1=$("#val1_"+String(s)+"_"+String(e)).val()
                val2=$("#val2_"+String(s)+"_"+String(e)).val()
                tot1=$("#tot1_"+String(s)+"_"+String(e)).val()
                tot2=$("#tot2_"+String(s)+"_"+String(e)).val()

                hex1=''
                if(Number.isInteger(parseInt(val1))){
                    hex1=parseInt(val1).toString(16)
                }
                hex2=''
                if(Number.isInteger(parseInt(val2))){
                    hex2=parseInt(val2).toString(16)
                }
                hex3=''
                if(Number.isInteger(parseInt(tot1))){
                    hex3=parseInt(tot1).toString(16)
                }
                hex4=''
                if(Number.isInteger(parseInt(tot2))){
                    hex4=parseInt(tot2).toString(16)
                }
                
                excel_row=excel_row+1
                cee="C"+excel_row
                dee="D"+excel_row
                eff="F"+excel_row
                gee="G"+excel_row

                console.log(
                    "diabled check",String(s),String(e),excel_row,
                    $("#tot1_"+String(s)+"_"+String(e)).hasClass("pretend_disabled"),
                    $("#tot2_"+String(s)+"_"+String(e)).hasClass("pretend_disabled")
                )
                cell=$("<td />").html(per1); row.append(cell);
                cell=$("<td />").html(val1); row.append(cell);
                if($("#tot1_"+String(s)+"_"+String(e)).hasClass("pretend_disabled")){
                    cell=$("<td />").html("="+cee+"*"+dee); row.append(cell);
                }else{
                    cell=$("<td />").html(tot1);row.append(cell);
                }

                cell=$("<td />").html(per2); row.append(cell);
                cell=$("<td />").html(val2); row.append(cell);
                if($("#tot2_"+String(s)+"_"+String(e)).hasClass("pretend_disabled")){
                    cell=$("<td />").html("="+eff+"*"+gee); row.append(cell);
                }else{
                    cell=$("<td />").html(tot2);row.append(cell);
                }
                
                exp.append(row)
                v=v+String(per1)+delim+hex1+delim+hex3+delim+String(per2)+delim+hex2+delim+hex4+sep
            }
        }

        rl.html(window.location.origin+window.location.pathname+"?s="+String(scenario)+"&t="+String(parseInt(target).toString(16))+"&v="+v)
        //$("#exportable").removeClass("d-none")
        tableToExcel('exportable', 'Income Data')
    }

    var tableToExcel = (function() {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
            , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
        return function(table, name) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML}
            window.location.href = uri + base64(format(template, ctx))
        }
    })()

    /*---------------------------------------------------------------------------------------------------
    ------------------------------------------    listeners    ------------------------------------------
    -----------------------------------------------------------------------------------------------------*/
    $(function(){
        $('[data-toggle="tooltip"]').tooltip()
    })

    $(".btn_compare").click(function(){
        
        this_id=$(this).attr("id")
        $(".btn_compare").removeClass("btn-primary")
        $(".btn_compare").addClass("btn-outline-primary");
        $(this).removeClass("btn-outline-primary").addClass("btn-primary")
        if(this_id=="btn_compare_recording"){
            selected_proportion=0;  
        }else if(this_id=="btn_compare_live"){
            selected_proportion=1;   
        }else if(this_id=="btn_compare_publishing"){
            selected_proportion=2; 
        }

        chart();    

    })

    $("#btn_target").click(function(){
        target=parseInt($("#target").val())
        fn_scenario_update()
        
        //switch to Plan

        //turn off all the menus and hide the content
        $(".these_menus").addClass("d-none");
        $(".div_content").addClass("d-none")
            
        //highlight this menu item
        $(".tinker_menu").removeClass("d-none")

        $("#current_content").removeClass("d-none")
        $(".proposed").removeClass("d-none")
        $("#chart_content").removeClass("d-none")

    })

    $( "#frm" ).on( "submit", function( event ) {
        //alert( "Handler for `submit` called." );
        event.preventDefault();
    });

    $(".current").change(function(){
        which_field=$(this).attr("id").substring(3)
        console.log($(this).attr("id"),which_field);
        if($(this).attr("id").substring(0,3)!='tot'){
            if($("#per"+which_field).val()!="" && $("#val"+which_field).val() !="" ){
                $("#tot"+which_field).val($("#per"+which_field).val() * $("#val"+which_field).val())
            }
        }
        fn_scenario_update()
    })
    $(".prop").change(function(){
        which_field=$(this).attr("id").substring(3)
        if($(this).attr("id").substring(0,3)!='tot'){
            if($("#per"+which_field).val()!="" && $("#val"+which_field).val() !="" ){
                $("#tot"+which_field).val($("#per"+which_field).val() * $("#val"+which_field).val())
            }
        }
        fn_scenario_update()
    })

    $(".tot_unit").click(function(){
        
        triggering_div =  $(this).attr("id")
        data_entry = triggering_div.substring(7)
        tot_input = $("#tot" + data_entry)
        per_input = $("#per" + data_entry)
        val_input = $("#val" + data_entry)
        //if we clicked on the total
        if(triggering_div.substring(4,7)=="tot"){
            tot_input.removeClass("pretend_disabled")
            per_input.addClass("pretend_disabled").val("")
            val_input.addClass("pretend_disabled").val("")
        //if we clicked on either the units or per unit amount
        }else{
            //wipe the existing amount and turn it off
            tot_input.addClass("pretend_disabled").val("")
            //make sure that neither units nor per units fields are disabled
            per_input.removeClass("pretend_disabled")
            val_input.removeClass("pretend_disabled")
        }

    })

    $(".toggle_section").click(function(){
        var this_section = String(this.id.split("toggle_")[1])
        var isShowing = $(".row_"+this_section).hasClass("d-none")
        
        var dv=$("#row_" + this_section)

        //turn everything off
        $(".toggle_section").removeClass("bi-dash-square").addClass("bi-plus-square")
        $(".entry_row").addClass("d-none")
        $(".section_headings").html("&nbsp;")//and make the section headings disappear
        
        //if we not already showing this section, turn it on
        if(isShowing){
            $("#toggle_"+this_section).addClass("bi-dash-square").removeClass("bi-plus-square")
            $(".row_"+this_section).removeClass("d-none")

            $("#section_heading_lbsper1_"+this_section).html("£/Unit")
            $("#section_heading_units1_"+this_section).html("Units")
            $("#section_heading_lbsper2_"+this_section).html("£/Unit")
            $("#section_heading_units2_"+this_section).html("Units")
         
        }
    })

    $(".menus").click(function(){

        clicked = this.id
        //console.log("menu",clicked)
        menu_class="." + clicked.replace("a_","") + "_menu"
        content_id="#" + clicked.replace("a_","") + "_content"

        if(clicked!="a_excel"){

            //turn off all the menus and hide the content
            $(".these_menus").addClass("d-none");
            $(".div_content").addClass("d-none")
            
            //highlight this menu item
            $(menu_class).removeClass("d-none")

            if(clicked == "a_tinker"){
                $("#current_content").removeClass("d-none")
                $(".proposed").removeClass("d-none")
                $("#chart_content").removeClass("d-none")
                
            }else{
                $(content_id).removeClass("d-none")
                $(".proposed").addClass("d-none")
            }
            
        }else{
            fn_export_excel()
       }
    })

});
</script>
</body>
</html>